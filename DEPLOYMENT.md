# Deployment Guide for Render

This guide will help you deploy ChamaFunding to [Render](https://render.com).

## Prerequisites

- A Render account (sign up at [render.com](https://render.com))
- GitHub repository with your code
- Payment gateway credentials (PayPal, Stripe, M-Pesa)

## Quick Deploy (Recommended)

### Step 1: Connect Repository

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click "New +" → "Blueprint"
3. Connect your GitHub repository
4. Render will automatically detect `render.yaml` and deploy all services

### Step 2: Configure Environment Variables

After deployment, configure these environment variables in the Render dashboard for the **chamafunding-web** service:

#### Required Variables

- `APP_KEY` - Auto-generated by Render (already set)
- `APP_URL` - Your Render service URL (e.g., `https://chamafunding-web.onrender.com`)

#### Payment Gateway Variables

**PayPal:**
- `PAYPAL_MODE` - `sandbox` or `live`
- `PAYPAL_CLIENT_ID` - Your PayPal client ID
- `PAYPAL_CLIENT_SECRET` - Your PayPal client secret
- `PAYPAL_WEBHOOK_ID` - Your PayPal webhook ID (optional)

**Stripe:**
- `STRIPE_KEY` - Your Stripe publishable key
- `STRIPE_SECRET` - Your Stripe secret key
- `STRIPE_WEBHOOK_SECRET` - Your Stripe webhook secret

**M-Pesa:**
- `MPESA_CONSUMER_KEY` - Your M-Pesa consumer key
- `MPESA_CONSUMER_SECRET` - Your M-Pesa consumer secret
- `MPESA_SHORTCODE` - Your M-Pesa shortcode
- `MPESA_PASSKEY` - Your M-Pesa passkey
- `MPESA_ENVIRONMENT` - `sandbox` or `live`
- `MPESA_CALLBACK_URL` - `https://your-app.onrender.com/api/v1/mpesa/webhook`

#### Email Configuration (Optional)

- `MAIL_MAILER` - `smtp`, `ses`, `postmark`, etc.
- `MAIL_HOST` - SMTP host
- `MAIL_PORT` - SMTP port (usually 587 or 465)
- `MAIL_USERNAME` - SMTP username
- `MAIL_PASSWORD` - SMTP password
- `MAIL_ENCRYPTION` - `tls` or `ssl`
- `MAIL_FROM_ADDRESS` - Email address for outgoing emails
- `MAIL_FROM_NAME` - Display name for outgoing emails

#### AWS S3 (Optional, for file storage)

- `AWS_ACCESS_KEY_ID` - AWS access key
- `AWS_SECRET_ACCESS_KEY` - AWS secret key
- `AWS_DEFAULT_REGION` - AWS region (e.g., `us-east-1`)
- `AWS_BUCKET` - S3 bucket name
- `AWS_USE_PATH_STYLE_ENDPOINT` - `false` (default)

### Step 3: Sync APP_KEY Between Services

⚠️ **Important**: After the first deployment, you need to copy the `APP_KEY` from the web service to the worker service so they share the same encryption key:

1. Go to the **chamafunding-web** service in Render dashboard
2. Copy the `APP_KEY` value from Environment variables
3. Go to the **chamafunding-queue** service
4. Update the `APP_KEY` environment variable with the value from the web service

This ensures both services can encrypt/decrypt data correctly.

### Step 4: Automatic Migrations

✅ **Migrations run automatically!** The startup script automatically runs database migrations on every deployment and service restart. No manual intervention needed.

### Step 5: Seed Initial Data (Optional)

If you need to seed initial data, run:

```bash
render run chamafunding-web php artisan db:seed --class=RolesSeeder
```

### Step 6: Post-Deployment Setup

✅ **Storage link and caching are handled automatically!** The startup script creates the storage link and caches configuration, routes, and views automatically.

1. **Set up Webhooks**
   Configure webhooks in your payment gateway dashboards:
   - **PayPal**: `https://your-app.onrender.com/api/v1/paypal/webhook`
   - **Stripe**: `https://your-app.onrender.com/api/v1/stripe/webhook`
   - **M-Pesa**: `https://your-app.onrender.com/api/v1/mpesa/webhook`

## Services Deployed

The `render.yaml` configuration automatically deploys:

1. **Web Service** (`chamafunding-web`)
   - Main application server
   - Handles HTTP requests
   - Health check endpoint: `/up`

2. **Queue Worker** (`chamafunding-queue`)
   - Processes background jobs
   - Handles email sending, notifications, etc.

3. **PostgreSQL Database** (`chamafunding-db`)
   - Primary database
   - PostgreSQL 16
   - Starter plan

4. **Redis** (`chamafunding-redis`)
   - Cache storage
   - Session storage
   - Queue backend
   - Starter plan

## Manual Deployment

If you prefer to deploy services manually instead of using the Blueprint:

### 1. Create PostgreSQL Database

1. Go to Render Dashboard
2. Click "New +" → "PostgreSQL"
3. Configure:
   - **Name**: `chamafunding-db`
   - **Database**: `chamafunding`
   - **User**: `chamafunding`
   - **Plan**: Starter
   - **Region**: Oregon (or your preferred region)

### 2. Create Redis Instance

1. Click "New +" → "Redis"
2. Configure:
   - **Name**: `chamafunding-redis`
   - **Plan**: Starter
   - **Region**: Oregon (same as database)

### 3. Create Web Service

1. Click "New +" → "Web Service"
2. Connect your GitHub repository
3. Configure:
   - **Name**: `chamafunding-web`
   - **Runtime**: Docker
   - **Dockerfile Path**: `./Dockerfile`
   - **Build Command**: (leave empty)
   - **Start Command**: `php artisan serve --host=0.0.0.0 --port=$PORT`
   - **Plan**: Starter
   - **Region**: Oregon

4. **Add Environment Variables:**
   - Copy all environment variables from the `render.yaml` file
   - Update values as needed (especially payment gateway credentials)
   - Set `APP_URL` to your service URL

### 4. Create Worker Service

1. Click "New +" → "Background Worker"
2. Connect your GitHub repository
3. Configure:
   - **Name**: `chamafunding-queue`
   - **Runtime**: Docker
   - **Dockerfile Path**: `./Dockerfile`
   - **Start Command**: `php artisan queue:work --tries=3 --timeout=90`
   - **Plan**: Starter
   - **Region**: Oregon

4. **Add Environment Variables:**
   - Copy from `chamafunding-web` service
   - Ensure `APP_KEY` matches the web service

## Environment Variables Reference

See `.env.example` for a complete list of all environment variables.

### Key Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `APP_NAME` | Application name | Yes |
| `APP_ENV` | Environment (`production`, `local`) | Yes |
| `APP_KEY` | Laravel encryption key | Yes |
| `APP_DEBUG` | Debug mode (`false` for production) | Yes |
| `APP_URL` | Application URL | Yes |
| `DB_CONNECTION` | Database driver (`pgsql` for Render) | Yes |
| `CACHE_DRIVER` | Cache driver (`redis` for Render) | Yes |
| `SESSION_DRIVER` | Session driver (`redis` for Render) | Yes |
| `QUEUE_CONNECTION` | Queue driver (`redis` for Render) | Yes |

## Troubleshooting

### Service Won't Start

1. Check build logs in Render dashboard
2. Verify all required environment variables are set
3. Check that database and Redis are running
4. Review application logs: `render logs chamafunding-web`

### Database Connection Issues

1. Verify database credentials in environment variables
2. Check that database is in the same region as web service
3. Ensure `DB_CONNECTION=pgsql` is set

### Queue Jobs Not Processing

1. Verify `chamafunding-queue` service is running
2. Check Redis connection in environment variables
3. Review queue worker logs: `render logs chamafunding-queue`

### Assets Not Loading

1. Ensure `npm run build` completed successfully during build
2. Check that `public/build` directory exists
3. Verify `APP_URL` is set correctly

### Health Check Failing

1. Verify `/up` endpoint is accessible
2. Check application logs for errors
3. Ensure database connection is working

## Updating the Application

1. Push changes to your GitHub repository
2. Render will automatically detect and deploy updates
3. Monitor the deployment in the Render dashboard

## Scaling

To scale your application:

1. Upgrade service plans in Render dashboard
2. For high traffic, consider:
   - Upgrading to Standard or Pro plans
   - Adding multiple queue workers
   - Using a managed PostgreSQL database with backups

## Security Best Practices

1. **Never commit `.env` file** - Use Render environment variables
2. **Use strong passwords** for database and Redis
3. **Enable HTTPS** - Render provides this automatically
4. **Keep dependencies updated** - Regularly update Composer and npm packages
5. **Use production credentials** - Never use sandbox/test credentials in production
6. **Rotate secrets regularly** - Update API keys and passwords periodically

## Support

For issues specific to:
- **Render Platform**: [Render Documentation](https://render.com/docs)
- **Laravel**: [Laravel Documentation](https://laravel.com/docs)
- **This Application**: Check the project's issue tracker

## Additional Resources

- [Render Documentation](https://render.com/docs)
- [Laravel Deployment Guide](https://laravel.com/docs/deployment)
- [PayPal Setup Guide](./PAYPAL_SETUP.md)
- [M-Pesa Setup Guide](./MPESA_SETUP.md)

